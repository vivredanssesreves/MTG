<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>MTG Set Cards</title>
    <link rel="stylesheet" href="style.css" />
</head>

<body id="body">


    <header>
        <button id="back-btn" class="icon-moon back mouse-button-theme">⬅</button>
        <button id="dark-toggle" class="mouse-button-theme icon-moon">☾</button>

        <h1 id="set-title">Loading...</h1>

        <script>
            if (localStorage.getItem('darkMode') === 'enabled') {
                document.documentElement.classList.add('dark');
                document.body.classList.add('dark');
            }
        </script>

    </header>

    <main>
        <div id="cards-container"></div>
    </main>

    <script type="module">
        // Get query param "code"
        const params = new URLSearchParams(window.location.search);
        const setCode = params.get('code');

        // Back button
        document.getElementById('back-btn').onclick = () => {
            window.location.href = 'index.html';
        };

        // Dark mode toggle
        const darkToggle = document.getElementById('dark-toggle');
        darkToggle.onclick = () => {
            document.body.classList.toggle('dark');
            if (document.body.classList.contains('dark')) {
                localStorage.setItem('darkMode', 'enabled');
            } else {
                localStorage.removeItem('darkMode');
            }
        };

        window.addEventListener('load', () => {
            if (localStorage.getItem('darkMode') === 'enabled') {
                document.body.classList.add('dark');
            }
        });

        const setData = sessionStorage.getItem('selectedSet');
        let set;

        if (setData) {
            set = JSON.parse(setData);
            // name and code
            document.getElementById('set-title').textContent = `${set.name} (${set.code.toUpperCase()})`;

        } else {
            const params = new URLSearchParams(window.location.search);
            const setCode = params.get('code');
            if (!setCode) {
                document.getElementById('set-title').textContent = 'No set code provided';
                throw new Error('No set code provided in URL');
            }
            set = { code: setCode, name: setCode.toUpperCase() };
            document.getElementById('set-title').textContent = set.name;
        }

        async function loadSetCards(code) {
            try {

                const resCards = await fetch(`../bdd/${code}.json`);
                const resMyCards = await fetch(`../MYBDD/myCards.json`);
               
                if (!resCards.ok || !resMyCards.ok) throw new Error('Erreur de chargement');

                const cards = await resCards.json();
                const myCards = await resMyCards.json();
                const setData = myCards.sets.find(s => s.code === code) || { cards: [] };

                document.getElementById('set-title').innerHTML = `<img src="${set.icon_svg_uri}" alt="${set.name}" style="height:24px; vertical-align:middle; margin-right:8px;"> ${set.name}`;


                const container = document.getElementById('cards-container');
                container.innerHTML = '';

                cards.forEach(card => {
                    const cardDiv = document.createElement('div');
                    const owned = setData.cards.find(c => c.number === card.number) || { no_foil: false, foil: false };

                    cardDiv.className = 'card';

                    cardDiv.innerHTML = `
                        <img src="${card.imageUrl}" title="${card.name_fr}" />
                        <div class="card-info">
                            <div class="card-meta">
                            <div class="card-images">
                                <img src="${set.icon_svg_uri}" data-type="no_foil" data-set="${code}" data-num=${card.number} class="small-clickable ${owned.no_foil ? 'active' : ''}" />
                                <img src="${set.icon_svg_uri}" data-type="foil" data-set="${code}" data-num=${card.number} class="small-clickable foil ${owned.foil ? 'active' : ''}" />
                            </div>
                            <div class="icon-card-right "># ${card.number} 
                                <a href="${card.link}" >
                                       <img src="https://www.freeiconspng.com/uploads/search-icon-png-5.png" class="icon-search"/>                                    
                                </a>
                            </div>
                            </div>
                        </div>`;

                    container.appendChild(cardDiv);
                });
            } catch (error) {
                document.getElementById('set-title').textContent = 'Error loading cards';
                console.error(error);
            }
        }

        loadSetCards(setCode);

    </script>

    <script defer type="module" src="/backEnd/gestion_collect_perso.js"></script>
</body>

</html>